services:
  # MongoDB 8.0 with vector search support
  mongodb:
    image: mongo:8.0
    container_name: action-atlas-mongodb
    ports:
      - "27018:27017"
    restart: unless-stopped
    networks:
      - challenges_vector
    volumes:
      - mongodb_data:/data/db
      - ./scripts/docker-init:/docker-entrypoint-initdb.d:ro
    command: ["--replSet", "rs0", "--bind_ip_all"]
    healthcheck:
      test: ["CMD", "mongosh", "--quiet", "--eval", "db.adminCommand('ping').ok"]
      interval: 5s
      timeout: 10s
      retries: 10
      start_period: 30s
    networks:
      - action-atlas-network

  # mongot - MongoDB Search Binary (required for vector search)
  mongot:
    image: mongodb/mongodb-community-search:0.53.1
    container_name: action-atlas-mongot
    environment:
      - MONGODB_URI=mongodb://mongodb:27017
    depends_on:
      mongo_vector_main:
        condition: service_healthy
    restart: "no"
    entrypoint: ["bash", "/app-initializer/vector-init.sh"]
    networks:
      - action-atlas-network

  # Init container - Sets up replica set and loads data
  mongodb-init:
    build:
      context: .
      dockerfile: Dockerfile.init
    container_name: action-atlas-init
    depends_on:
      mongodb:
        condition: service_healthy
    volumes:
      - ./scripts/docker-init:/scripts:ro
      - ./data:/data:ro
    command: >
      bash -c "
        echo 'Waiting for MongoDB to be ready...'
        sleep 5

        echo 'Initializing replica set...'
        mongosh --host mongodb:27017 --eval '
          rs.initiate({
            _id: \"rs0\",
            members: [{ _id: 0, host: \"mongodb:27017\" }]
          })
        '

        echo 'Waiting for replica set to be ready...'
        sleep 10

        echo 'Checking if data already exists...'
        COUNT=$$(mongosh --host mongodb:27017 --quiet --eval 'db.getSiblingDB(\"actionatlas\").activities.countDocuments()' || echo 0)

        if [ \"$$COUNT\" -eq \"0\" ]; then
          echo 'Loading data from GitHub Release or local file...'
          bash /scripts/load-data.sh
        else
          echo 'Data already loaded ($$COUNT activities found)'
        fi

        echo 'Creating vector search index...'
        bash /scripts/create-vector-index.sh

        echo 'âœ… MongoDB initialization complete!'
      "
    networks:
      - action-atlas-network
    restart: "no"

volumes:
  mongodb_data:
    driver: local

# NOTE: This uses MongoDB 8.0 which supports vector search via the $vectorSearch
# aggregation stage. Atlas-specific search indexes require Atlas or Atlas Local CLI.
# For development, you can use the aggregation pipeline directly with vector embeddings.
