version: '3.9'

services:
  # MongoDB 8.2 Community Edition with vector search support
  mongodb:
    image: mongodb/mongodb-community-server:8.2.0-ubi9
    container_name: action-atlas-mongodb
    ports:
      - "27017:27017"
    environment:
      - MONGO_INITDB_DATABASE=actionatlas
    volumes:
      - mongodb_data:/data/db
      - mongodb_config:/data/configdb
      - ./scripts/docker-init:/docker-entrypoint-initdb.d:ro
    command: --replSet rs0 --bind_ip_all
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - action-atlas-network

  # mongot - MongoDB Search Binary (required for vector search)
  mongot:
    image: mongodb/mongodb-community-search:0.53.1
    container_name: action-atlas-mongot
    environment:
      - MONGODB_URI=mongodb://mongodb:27017
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - action-atlas-network

  # Init container - Sets up replica set and loads data
  mongodb-init:
    image: mongodb/mongodb-community-server:8.2.0-ubi9
    container_name: action-atlas-init
    depends_on:
      mongodb:
        condition: service_healthy
    volumes:
      - ./scripts/docker-init:/scripts:ro
      - ./data:/data:ro
    command: >
      bash -c "
        echo 'Waiting for MongoDB to be ready...'
        sleep 5

        echo 'Initializing replica set...'
        mongosh --host mongodb:27017 --eval '
          rs.initiate({
            _id: \"rs0\",
            members: [{ _id: 0, host: \"mongodb:27017\" }]
          })
        '

        echo 'Waiting for replica set to be ready...'
        sleep 10

        echo 'Checking if data already exists...'
        COUNT=$(mongosh --host mongodb:27017 --quiet --eval 'db.getSiblingDB(\"actionatlas\").activities.countDocuments()' || echo 0)

        if [ \"$COUNT\" -eq \"0\" ]; then
          echo 'Loading data from GitHub Release or local file...'
          bash /scripts/load-data.sh
        else
          echo 'Data already loaded ($COUNT activities found)'
        fi

        echo 'Creating vector search index...'
        bash /scripts/create-vector-index.sh

        echo 'âœ… MongoDB initialization complete!'
      "
    networks:
      - action-atlas-network
    restart: "no"

volumes:
  mongodb_data:
    driver: local
  mongodb_config:
    driver: local

networks:
  action-atlas-network:
    driver: bridge
